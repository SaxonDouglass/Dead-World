var screens = {};
var nextID = 0;
var queue = [];

exports.random = function() {
	if(Math.random() < newChance(queue.length)) {
		console.log('New screen');
		var seed = Math.floor(Math.random()*6);
		var spec = generate(seed);
		var s = exports.create(spec);
		screens[s.id] = s;
		return s;
	} else {
		console.log('Old screen');
		return screens[queue.shift()];
	}
}

var newChance = function(n) {
	if(n > 3) {
		return 0;
	} else {
		return 1 - n/3;
	}
}

exports.free = function(s) {
	if(s instanceof Array) {
		s = s.slice(0);
		for(i = 0; i < s.length; i++) {
			j = i + Math.floor(Math.random()*(s.length - i));
			queue.push(s[j]);
			s[j] = s[i];
		}
	} else {
		queue.push(s);
	}
	console.log(queue);
}

var generate = function(seed) {
    var spec = {};
    spec.overworld = {};
	if (seed == 0) {
	    spec.overworld.data = [[4,3,3,3,3, 1,0,0,0,1, 3,3,3,3,5],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],

							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],

							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [2,0,0,0,0, 0,0,0,0,0, 0,0,0,0,2],
							   [7,3,3,3,3, 1,0,0,0,1, 3,3,3,3,6]
							  ];
    } else if (seed == 1) {
        spec.overworld.data = [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,1,1,1, 1,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],

							   [1,0,0,0,0, 0,0,0,0,1, 1,1,1,0,1],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,1,1,1, 1,0,0,0,0, 0,0,0,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [1,0,0,0,0, 0,0,0,0,1, 1,1,1,0,1],

							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,1,1,1, 1,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1]
							  ];
    } else if (seed == 2) {
        spec.overworld.data = [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,1,0,1, 0,0,0,0,0, 1,0,1,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,1,0,1, 0,0,0,0,0, 1,0,1,0,1],

							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [0,0,1,0,1, 0,32,0,32,0, 1,0,1,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,1,0,1, 0,32,0,32,0, 1,0,1,0,0],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],

							   [1,0,1,0,1, 0,0,0,0,0, 1,0,1,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,1,0,1, 0,0,0,0,0, 1,0,1,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1]
							  ];
    } else if (seed == 3) {
        spec.overworld.data = [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],

							   [1,0,0,0,1, 0,32,0,1,0, 1,0,0,0,1],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,1,0,1, 0,33,0,32,0, 1,0,1,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [1,0,0,0,1, 0,32,0,1,0, 1,0,0,0,1],

							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1]
							  ];
    } else if (seed == 4) {
        spec.overworld.data = [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1],
							   [1,0,0,0,0, 0,0,0,0,1, 0,0,0,0,1],
							   [1,0,0,1,1, 1,0,0,0,1, 0,0,1,1,1],
							   [1,0,1,1,0, 1,0,0,0,1, 0,0,0,0,1],
							   [1,0,1,0,0, 1,0,0,0,0, 0,1,0,0,1],

							   [1,1,1,0,1, 1,0,0,0,1, 1,1,0,1,1],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
							   [1,1,0,1,1, 1,0,0,0,1, 1,0,1,1,1],

							   [1,0,0,1,0, 1,0,0,0,1, 0,0,1,0,1],
							   [1,0,0,1,0, 0,0,0,0,1, 0,0,0,0,1],
							   [1,0,1,1,0, 1,0,0,0,1, 0,0,1,0,1],
							   [1,0,0,0,0, 1,0,0,0,0, 0,0,1,0,1],
							   [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1]
							  ];
    } else if (seed == 5) {
        spec.overworld.data = [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,1,1, 1,1,0,1,1, 1,1,0,0,1],
							   [1,0,0,1,0, 0,1,0,0,0, 0,1,0,0,1],

							   [1,0,0,0,0, 0,1,0,1,0, 0,1,0,0,1],
							   [0,0,0,1,0, 1,1,0,1,1, 0,1,0,0,0],
							   [0,0,0,1,0, 0,1,0,1,0, 0,1,0,0,0],
							   [0,0,0,1,1, 0,1,0,1,0, 1,1,0,0,0],
							   [1,0,0,1,0, 0,1,0,1,0, 0,0,0,0,1],

							   [1,0,0,1,0, 0,0,0,1,0, 0,1,0,0,1],
							   [1,0,0,1,1, 1,1,0,1,1, 1,1,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
							   [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1]
							  ];
    }
    
    return spec;
}

exports.get = function(id) {
	var screen = screens[id];
	if(!screen) {
		screen = exports.random();
	}
	return screen;
}

exports.set = function(s) {
	screens[s.id] = s;
}

exports.create = function(spec,my) {
	var that;
	my = my || {};
	spec = spec || {};
	
	that = {};

	if(spec.id && !screens[spec.id]) {
		that.id = spec.id;
		if(spec.id >= nextID) {
			nextID = spec.id;
		}
	} else {
		that.id = nextID;
		nextID++;
	}

	if(spec.monsters) {
		that.monsters = spec.monsters;
	} else {
		that.monsters = [
			{'x': 5, 'y': 7},
			{'x': 9, 'y': 7},
		];
	}
    
    if (spec.overworld) {
        that.overworld = spec.overworld;
    } else {
	    that.overworld = { 'data': [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1,],
									[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									[1,0,0,1,1, 1,0,0,0,1, 1,1,0,0,1,],
									[1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									
									[1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									[0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									[0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									[0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									[1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									
									[1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									[1,0,0,1,1, 1,0,0,0,1, 1,1,0,0,1,],
									[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1,],
								   ],
						 };
	    that.overworld.data[7][that.id] = 1;
	}

    if (spec.underworld) {
        that.underworld = spec.underworld;
    } else {
	    that.underworld = { 'data': [[1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1,],
									 [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									 [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									 [1,0,0,1,1, 1,0,0,0,1, 1,1,0,0,1,],
									 [1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									 
									 [1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									 [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									 [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									 [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,],
									 [1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									 
									 [1,0,0,1,0, 0,0,0,0,0, 0,1,0,0,1,],
									 [1,0,0,1,1, 1,0,0,0,1, 1,1,0,0,1,],
									 [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									 [1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1,],
									 [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1,],
									],
						  };
    }

	return that;
}
